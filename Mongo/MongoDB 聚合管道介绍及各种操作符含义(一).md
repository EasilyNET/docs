## MongoDB 聚合管道初步介绍及各种操作符含义(一)

- 哎,最近年末了,各种会议,总结写的我已经想吐了,现在打算来继续写之前 MongoDB 的一些小分享.
- 之前介绍了简单的 CRUD 操作,这次就深入一些,介绍下 MongoDB 的聚合管道.
- 这部分我使用的一般都是分组,可能讲的不是很深入,也不是很准确,不过都算是学习了.
- 比如网上还经常在说 MapReduce 其实在新版中,MongoDB 已经弃用了这个东西(从 5.0 开始).所以本文就不讲这个东西了,我其实也没学.😂
- 网上也有很多人讲这部分内容,但是我发现他们的资料大都停留在 2.x 或者 3.x 的版本,感觉可能和现在的一些说法不太准确,毕竟现在已经 6.x 时代了.
- 最常用的一些聚合操作其实就是分页,排序,求文档数量等操作,但是这些操作其实 MongoDB 的 C# API 或者使用 JavaScript 代码都能直接写,不太象是聚合管道的操作,但是实际上他们是一样的.
- 还是按照之前的风格,先介绍一下各种聚合操作符以及聚合管道运算符的详细内容.
- 首先看看官网对聚合管道的定义,以及官网对各个操作符的解释.
- 参考 [官网](https://www.mongodb.com/docs/manual/reference/operator/aggregation-pipeline/) 的详细介绍和原文
- https://www.mongodb.com/docs/manual/reference/operator/aggregation-pipeline/

---

```JavaScript
In the db.collection.aggregate() method and db.aggregate() method, pipeline stages appear in an array. Documents pass through the stages in sequence.
// 说中文大概就是如下意思
在db.collection.aggregation()方法和db.aggregation()方法中,管道阶段出现在一个数组中.文档按顺序通过这些阶段.
```

- 除了 \$out、\$merge、\$geoNear 和 \$changeStream 阶段外,所有阶段都可以在一个管道中出现多次.

- 按照我的理解其实就是和.NET 中的中间件差不多的意思.一个管道处理完交给下一个管道.所以我觉得这个东西组合起来后就非常的强大了.

### db.collection.aggregate()阶段

```JavaScript
// 语法
db.collection.aggregate( [ { <stage> }, ... ] );
```

| 阶段             | 描述                                                                                                                                                                                                                              | 英文原文                                                                                                                                                                                                                                                                                                                                                                                       |
| ---------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| $addFields       | 为文档添加新字段.与 \$project 类似, \$addFields 重塑了流中的每一个文档;具体来说,就是在输出文档中添加新的字段,其中包含输入文档中的现有字段和新添加的字段. \$set 是 \$addFields 的一个别名.                                         | Adds new fields to documents. Similar to \$project, \$addFields reshapes each document in the stream; specifically, by adding new fields to output documents that contain both the existing fields from the input documents and the newly added fields. $set is an alias for \$addFields.                                                                                                      |
| $bucket          | 根据指定的表达式和桶的边界,将传入的文档归类为组,称为桶.                                                                                                                                                                           | Categorizes incoming documents into groups, called buckets, based on a specified expression and bucket boundaries.                                                                                                                                                                                                                                                                             |
| $bucketAuto      | 根据指定的表达式,将收到的文档分类到特定数量的组,称为桶.桶的边界被自动确定,以试图将文件均匀地分配到指定数量的桶中.                                                                                                                 | Categorizes incoming documents into a specific number of groups, called buckets, based on a specified expression. Bucket boundaries are automatically determined in an attempt to evenly distribute the documents into the specified number of buckets.                                                                                                                                        |
| $changeStream    | 返回该集合的 ChangeStream 游标.这个阶段在一个聚合管道中只能出现一次,而且必须作为第一个阶段出现.                                                                                                                                   | Returns a Change Stream cursor for the collection. This stage can only occur once in an aggregation pipeline and it must occur as the first stage.                                                                                                                                                                                                                                             |
| $collStats       | 返回关于一个集合或视图的统计数据                                                                                                                                                                                                  | Returns statistics regarding a collection or view.                                                                                                                                                                                                                                                                                                                                             |
| $count           | 返回在聚合管道的这个阶段的文档数量的计数.区别于 \$count 聚合累加器.                                                                                                                                                               | Returns a count of the number of documents at this stage of the aggregation pipeline.Distinct from the \$count aggregation accumulator.                                                                                                                                                                                                                                                        |
| $densify         | 在一个文档序列中创建新的文档,其中缺少某个字段的某些值.                                                                                                                                                                            | Creates new documents in a sequence of documents where certain values in a field are missing.                                                                                                                                                                                                                                                                                                  |
| $documents       | 从输入表达式中返回字面文档                                                                                                                                                                                                        | Returns literal documents from input expressions.                                                                                                                                                                                                                                                                                                                                              |
| $facet           | 在同一输入文档集的单一阶段内处理多个聚合管道.能够创建多面聚合,能够在一个阶段内跨多个维度或面来描述数据的特征.                                                                                                                     | Processes multiple aggregation pipelines within a single stage on the same set of input documents. Enables the creation of multi-faceted aggregations capable of characterizing data across multiple dimensions, or facets, in a single stage.                                                                                                                                                 |
| $fill            | 在文档中填充空字段和缺失字段的值                                                                                                                                                                                                  | Populates null and missing field values within documents.                                                                                                                                                                                                                                                                                                                                      |
| $geoNear         | 根据与地理空间点的接近程度,返回一个有序的文档流.融合了 \$match、\$sort 和 \$limit 的地理空间数据的功能.输出的文档包括一个额外的距离字段,可以包括一个位置标识符字段.                                                               | Returns an ordered stream of documents based on the proximity to a geospatial point. Incorporates the functionality of \$match, \$sort, and \$limit for geospatial data. The output documents include an additional distance field and can include a location identifier field.                                                                                                                |
| $graphLookup     | 在一个集合上执行递归搜索.在每个输出的文档中,添加一个新的数组字段,包含该文档的递归搜索的遍历结果.                                                                                                                                  | Performs a recursive search on a collection. To each output document, adds a new array field that contains the traversal results of the recursive search for that document.                                                                                                                                                                                                                    |
| $group           | 按指定的标识符表达式对输入的文档进行分组,并将累加器表达式（如果指定的话）应用于每个组.消耗所有的输入文档,每个不同的组输出一个文档.输出的文档只包含标识符字段,如果指定的话,还包含累积字段.                                         | Groups input documents by a specified identifier expression and applies the accumulator expression(s), if specified, to each group. Consumes all input documents and outputs one document per each distinct group. The output documents only contain the identifier field and, if specified, accumulated fields.                                                                               |
| $indexStats      | 返回有关集合的每个索引使用情况的统计数据.                                                                                                                                                                                         | Returns statistics regarding the use of each index for the collection.                                                                                                                                                                                                                                                                                                                         |
| $limit           | 将未修改的前 n 个文档传递给管道,其中 n 是指定的限制.对于每个输入的文件,输出一个文件（前 n 个文件）或 0 个文件（前 n 个文件之后）.                                                                                                 | Passes the first n documents unmodified to the pipeline where n is the specified limit. For each input document, outputs either one document (for the first n documents) or zero documents (after the first n documents).                                                                                                                                                                      |
| $listSessions    | 列出所有活动时间长到足以传播到 system.session 集合的会话.                                                                                                                                                                         | Lists all sessions that have been active long enough to propagate to the system.sessions collection.                                                                                                                                                                                                                                                                                           |
| $lookup          | 对同一数据库中的另一个集合进行左外联接,从 "联接" 的集合中过滤文档进行处理.                                                                                                                                                        | Performs a left outer join to another collection in the same database to filter in documents from the "joined" collection for processing.                                                                                                                                                                                                                                                      |
| $match           | 过滤文档流,只允许匹配的文档未经修改地进入下一个流水线阶段. \$match 使用标准的 MongoDB 查询.对于每个输入文档,输出一个文档（匹配）或零文档（不匹配）.                                                                               | Filters the document stream to allow only matching documents to pass unmodified into the next pipeline stage. \$match uses standard MongoDB queries. For each input document, outputs either one document (a match) or zero documents (no match).                                                                                                                                              |
| $merge           | 将聚合管道的结果文档写入一个集合.该阶段可以将（插入新的文档、合并文档、替换文档、保留现有的文档、操作失败、用自定义的更新管道处理文档）结果纳入一个输出集合.要使用\$merge 阶段,它必须是流水线中的最后一个阶段.4.2 版本中的新功能. | Writes the resulting documents of the aggregation pipeline to a collection. The stage can incorporate (insert new documents, merge documents, replace documents, keep existing documents, fail the operation, process documents with a custom update pipeline) the results into an output collection. To use the \$merge stage, it must be the last stage in the pipeline. New in version 4.2. |
| $out             | 将聚合管道的结果文档写入一个集合.要使用 \$out 阶段,它必须是流水线的最后一个阶段.                                                                                                                                                  | Writes the resulting documents of the aggregation pipeline to a collection. To use the \$out stage, it must be the last stage in the pipeline.                                                                                                                                                                                                                                                 |
| $planCacheStats  | 返回一个集合的计划缓存信息                                                                                                                                                                                                        | Returns plan cache information for a collection.                                                                                                                                                                                                                                                                                                                                               |
| $project         | 重塑数据流中的每个文档,例如增加新的字段或删除现有的字段.对于每个输入的文档,输出一个文档.另见 \$unset 用于移除现有字段.                                                                                                            | Reshapes each document in the stream, such as by adding new fields or removing existing fields. For each input document, outputs one document.See also \$unset for removing existing fields.                                                                                                                                                                                                   |
| $redact          | 根据存储在文档中的信息,通过限制每个文档的内容来重塑流中的每个文档.结合了 \$project 和 \$match 的功能.可以用来实现字段级的编辑.对于每个输入的文档,输出一个或零个文档.                                                              | Reshapes each document in the stream by restricting the content for each document based on information stored in the documents themselves. Incorporates the functionality of \$project and \$match. Can be used to implement field level redaction. For each input document, outputs either one or zero documents.                                                                             |
| $replaceRoot     | 用指定的嵌入式文档替换一个文档.该操作替换了输入文档中的所有现有字段,包括 \_id 字段.指定一个嵌入在输入文档中的文档,将嵌入的文档提升到最高级别. \$replaceWith 是\$replaceRoot 阶段的一个别名.                                       | Replaces a document with the specified embedded document. The operation replaces all existing fields in the input document, including the \_id field. Specify a document embedded in the input document to promote the embedded document to the top level. \$replaceWith is an alias for \$replaceRoot stage.                                                                                  |
| $replaceWith     | 用指定的嵌入式文档替换一个文档.该操作替换了输入文档中的所有现有字段,包括 \_id 字段.指定一个嵌入在输入文档中的文档,将嵌入的文档提升到最高级别. \$replaceWith 是\$replaceRoot 阶段的一个别名.                                       | Replaces a document with the specified embedded document. The operation replaces all existing fields in the input document, including the \_id field. Specify a document embedded in the input document to promote the embedded document to the top level. \$replaceWith is an alias for \$replaceRoot stage.                                                                                  |
| $sample          | 从其输入中随机选择指定数量的文件.                                                                                                                                                                                                 | Randomly selects the specified number of documents from its input.                                                                                                                                                                                                                                                                                                                             |
| $set             | 为文档添加新字段.与 \$project 类似, \$set 重塑了流中的每一个文档；具体来说,就是在输出文档中添加新的字段,其中包含输入文档中的现有字段和新添加的字段. \$set 是\$addFields 阶段的一个别名.                                           | Adds new fields to documents. Similar to \$project, \$set reshapes each document in the stream; specifically, by adding new fields to output documents that contain both the existing fields from the input documents and the newly added fields. \$set is an alias for \$addFields stage.                                                                                                     |
| $setWindowFields | 将文档分组到窗口,并对每个窗口中的文档应用一个或多个运算符.5.0 版的新功能.                                                                                                                                                         | Groups documents into windows and applies one or more operators to the documents in each window. New in version 5.0.                                                                                                                                                                                                                                                                           |
| $skip            | 跳过前 n 个文档,其中 n 是指定的跳过次数,并将剩余的文档不加修改地传递给管道.对于每个输入文件,输出零个文件（对于前 n 个文件）或一个文件（如果在前 n 个文件之后）.                                                                   | Skips the first n documents where n is the specified skip number and passes the remaining documents unmodified to the pipeline. For each input document, outputs either zero documents (for the first n documents) or one document (if after the first n documents).                                                                                                                           |
| $sort            | 按指定的排序键重新排列文档流.仅仅是顺序的改变,文档保持不变.对于每一个输入文档,输出一个文档.                                                                                                                                       | Reorders the document stream by a specified sort key. Only the order changes; the documents remain unmodified. For each input document, outputs one document.                                                                                                                                                                                                                                  |
| $sortByCount     | 根据指定的表达式的值对进入的文档进行分组,然后计算每个不同组中的文档数.                                                                                                                                                            | Groups incoming documents based on the value of a specified expression, then computes the count of documents in each distinct group.                                                                                                                                                                                                                                                           |
| $unionWith       | 执行两个集合的联合；即把两个集合的管道结果合并为一个结果集.4.4 版本中的新功能.                                                                                                                                                    | Performs a union of two collections; i.e. combines pipeline results from two collections into a single result set. New in version 4.4.                                                                                                                                                                                                                                                         |
| $unset           | 从文档中删除/排除字段. \$unset 是 \$project 阶段的一个别名,用于删除字段.                                                                                                                                                          | Removes/excludes fields from documents. \$unset is an alias for \$project stage that removes fields.                                                                                                                                                                                                                                                                                           |
| $unwind          | 从输入文档中解构一个数组字段,为每个元素输出一个文档.每个输出的文档用一个元素值替换数组.对于每个输入文档,输出 n 个文档,其中 n 是数组元素的数量,对于空数组可以是零.                                                                 | Deconstructs an array field from the input documents to output a document for each element. Each output document replaces the array with an element value. For each input document, outputs n documents where n is the number of array elements and can be zero for an empty array.                                                                                                            |

- 以上就是 db.collection.aggregate()阶段的聚合管道其中还有两个操作符仅支持 MongoDB Atlas clusters,所以一般人用不到,除非你买他们的云服务版 MongoDB.
- 并且 \$searchMeta 需要 MongoDB 版本大于 4.4.9

| 阶段        | 描述                                                      | 英文原文                                                                                                     |
| ----------- | --------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ |
| $search     | 对一个或多个字段进行全文搜索                              | Performs a full-text search of the field or fields in an Atlas collection.                                   |
| $searchMeta | 对一个或多个字段进行全文搜索,返回不同类型的元数据结果文档 | Returns different types of metadata result documents for the Atlas Search query against an Atlas collection. |

---

### db.aggregate()阶段

```JavaScript
// 语法
db.aggregate( [ { <stage> }, ... ] )
```

- 以下阶段使用 db.aggregate()方法而不是 db.collection.aggregate()方法.

| 阶段               | 描述                                                                                                         | 英文原文                                                                                                                                                                      |
| ------------------ | ------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| $changeStream      | 返回该集合的 ChangeStream 游标.这个阶段在一个聚合管道中只能出现一次,而且必须作为第一个阶段出现.              | Returns a Change Stream cursor for the collection. This stage can only occur once in an aggregation pipeline and it must occur as the first stage.                            |
| $currentOp         | 返回关于 MongoDB 部署的活动和/或休眠操作的信息.                                                              | Returns information on active and/or dormant operations for the MongoDB deployment.                                                                                           |
| $listLocalSessions | 列出所有最近在当前连接的 mongos 或 mongod 实例上使用的活动会话.这些会话可能还没有传播到 system.session 集合. | Lists all active sessions recently in use on the currently connected mongos or mongod instance. These sessions may have not yet propagated to the system.sessions collection. |
| $documents         | 从输入值返回字面文档                                                                                         | Returns literal documents from input values.                                                                                                                                  |

- 可用于更新的阶段
- 从 MongoDB 4.2 开始,您可以使用聚合管道 更新在:

| 命令          | mongosh 方法                                                                                                                                   |
| ------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| findAndModify | db.collection.findOneAndUpdate（）<br/> db.collection.findAndModify（）                                                                        |
| update        | db.collection.updateOne（）<br/> db.collection.updateMany（）<br/> Bulk.find.update（）<br/> Bulk.find.updateOne（）<br/> Bulk.find.upsert（） |

对于更新,管道可以包含以下阶段:

- \$addFields 及其别名 \$set
- \$project 及其别名 \$unset
- \$replaceRoot 及其别名 \$replaceWith.

---

- 上边的内容基本上是按照官网的内容搬运过来,将其中的操作符描述翻译成了中文,便于理解一些.
- 今天暂时先写到这里.明天应该会先继续介绍一下管道中的聚合函数(Aggregation Pipeline Operators)
- 而且聚合函数的内容相当多,粗略看了下大概有不下 100 个,估计明天我也不会把所有的都写出来,而是挑几个常用的简单介绍一下,并结合代码来展示.
- 由于这些介绍完后,才能通过 C# 代码来体现其中的效果.不然出现没有介绍的操作符容易产生疑惑.所以代码今天暂时就不写了.已经晚上 **23 点+** 了.
